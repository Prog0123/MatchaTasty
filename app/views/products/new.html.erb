<!-- 投稿ページ -->
<div class="pt-8 pb-4">
  <!-- ステップバー -->
  <div class="max-w-2xl w-full mx-auto px-4">
    <div class="bg-gray-200 rounded-full h-2.5 mb-2">
      <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%;"></div>
    </div>

    <!-- ステップ名 -->
    <div class="flex justify-between max-w-2xl mx-auto mb-8 px-4" id="step-labels">
      <% steps = [
        { number: 1, label: "商品情報", description: "商品名・店舗名・価格を入力" },
        { number: 2, label: "味覚評価", description: "5段階で評価" },
        { number: 3, label: "コメント", description: "自由に感想を書く" }
      ] %>

      <% steps.each_with_index do |step, index| %>
        <div class="flex flex-col items-center w-1/3">
          <!-- ステップ番号アイコン -->
          <div id="step-circle-<%= index + 1 %>" class="w-8 h-8 rounded-full border-2 border-primary text-primary flex items-center justify-center mb-2 font-bold">
            <%= step[:number] %>
          </div>
          <div class="text-sm font-semibold text-gray-800 step-label-text"><%= step[:label] %></div>
          <div class="text-xs text-gray-500 text-center mt-1"><%= step[:description] %></div>
        </div>
      <% end %>
    </div>

    <%= form_with model: @product, local: true, class: "space-y-4" do |f| %>
      <!-- ステップ1: 商品情報 -->
      <div class="max-w-xl mx-auto card bg-white shadow-md p-6 rounded-xl">
        <div id="step-1" class="step-panel" data-step="1">
          <div class="form-control">
            <%= f.label :name, class: "label" do %>
              <span class="label-text">商品名<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <%= f.text_field :name, class: "input input-bordered w-full", placeholder: "例：チョコレートケーキ", required: true %>
          </div>

          <div class="form-control">
            <%= f.label :shop_name, class: "label" do %>
              <span class="label-text">店舗名<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <%= f.text_field :shop_name, class: "input input-bordered w-full", placeholder: "例：パティスリー○○", required: true %>
          </div>

          <div class="form-control">
            <%= f.label :category, class: "label" do %>
              <span class="label-text">カテゴリ<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <%= f.select :category, [
              ["ケーキ", "cake"],
              ["デザート", "dessert"],
              ["アイス", "ice_cream"],
              ["和菓子", "japanese_sweets"],
              ["ドリンク", "drink"],
              ["パフェ", "parfait"],
              ["その他", "other"]
            ], { prompt: "カテゴリを選択してください" }, { class: "select select-bordered w-full", required: true } %>
          </div>

          <div class="form-control">
            <%= f.label :price, class: "label" do %>
              <span class="label-text">価格（円）<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <div class="relative">
              <%= f.number_field :price, class: "input input-bordered w-full pr-12", placeholder: "500", min: 0, required: true %>
              <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">円</span>
            </div>
          </div>

          <div class="form-control">
            <%= f.label :tag_names, class: "label" do %>
              <span class="label-text">タグ（ , カンマ区切り）</span>
            <% end %>
            <%= f.text_field :tag_names, value: @product.tag_names, class: "input input-bordered w-full", placeholder: "例：チョコレート, 濃厚, おすすめ" %>
          </div>

          <div class="flex justify-end mt-4">
            <button type="button" class="next-button btn btn-primary mt-4">次へ</button>
          </div>
        </div>

        <!-- ステップ2 & 3: レビュー入力 + コメント -->
        <%= f.fields_for :review do |rf| %>
          <!-- ステップ2: 味覚評価 -->
          <div id="step-2" class="step-panel hidden" data-step="2">
            <div class="divider">レビュー情報</div>
            <p class="text-sm text-gray-600 mb-4 text-center">各項目を5段階で評価してください</p>

            <% [
              ["濃さ", :richness, "★", true],
              ["甘さ", :sweetness, "★", true],
              ["苦味", :bitterness, "★", true],
              ["後味", :aftertaste, "★", true],
              ["見た目", :appearance, "★", true]
            ].each do |label, name, symbol| %>
              <div class="form-control mb-4"
                   data-controller="stars"
                   data-stars-name="product[review_attributes][<%= name %>]"
                   data-stars-symbol-value="<%= symbol %>">

              <!-- 各要素を個別に調整可能なコンテナ -->
              <div class="flex items-center w-full relative star-rating-container">
                <!-- ラベル部分 -->
                <div class="ml-10 w-20 flex-shrink-0 label-section">
                  <label class="label">
                    <span class="label-text font-medium"><%= label %><span class="text-red-500 ml-1">*</span></span>
                  </label>
                </div>

                <!-- 星評価部分 -->
                <div class="ml-19 flex space-x-1 star-section">
                  <% 5.times do |i| %>
                    <i class="star cursor-pointer text-2xl text-gray-400 hover:text-yellow-400 transition-colors"
                       data-action="click->stars#select"
                       data-value="<%= i + 1 %>"><%= symbol %></i>
                  <% end %>
                </div>

                <!-- 数値表示部分 -->
                <div class="ml-20 flex items-center bg-gray-100 px-3 py-1 rounded-lg display-section">
                  <span class="text-xl font-bold text-gray-700 min-w-[2rem]" data-stars-target="display">
                    <%= @product.review&.send(name) || 0 %>
                  </span>
                  <span class="text-sm text-gray-500 ml-1">/ 5</span>
                </div>
              </div>
              
              <%= rf.hidden_field name, 
                  value: @product.review&.send(name) || 0,
                  data: { stars_target: "input" } %>
            </div>
            <% end %>

            <!-- ステップ2のナビゲーション -->
            <div class="flex justify-between mt-4">
              <button type="button" class="prev-button btn btn-secondary">戻る</button>
              <button type="button" class="next-button btn btn-primary">次へ</button>
            </div>
          </div>

          <!-- ステップ3: 画像とコメント -->
          <div id="step-3" class="step-panel hidden" data-step="3">
            <div class="form-control">
              <%= f.label :image, class: "label" do %>
                <span class="label-text">画像</span>
              <% end %>
              <%= f.file_field :image, class: "file-input file-input-bordered w-full", accept: "image/*" %>
              <label class="label">
                <span class="label-text-alt text-gray-500 image-upload-text">JPG、PNG、GIF形式の画像をアップロードしてください</span>
              </label>
            </div>

            <div class="form-control">
              <%= rf.label :comment, class: "label" do %>
                <span class="label-text">コメント</span>
              <% end %>
              <%= rf.text_area :comment, class: "textarea textarea-bordered w-full h-32", placeholder: "商品の感想や気づいたことを自由にお書きください..." %>
            </div>

            <!-- ステップ3のナビゲーション -->
            <div class="flex justify-between mt-6">
              <button type="button" class="prev-button btn btn-secondary">戻る</button>
              <%= f.submit "商品を投稿する", class: "btn btn-primary" %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
/* スマホ対応のレスポンシブCSS */
@media (max-width: 768px) {
  /* 星評価のレイアウト調整 */
  .star-rating-container {
    flex-wrap: wrap;
    justify-content: flex-start;
    gap: 0;
  }

  .label-section {
    margin-left: 0;
    width: 100%;
    margin-bottom: 8px;
  }

  .star-section {
    margin-left: 0;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .display-section {
    margin-left: 0;
    flex-shrink: 0;
  }

  /* 星と数値を中央揃えにする */
  .star-rating-container .star-section,
  .star-rating-container .display-section {
    width: 100%;
    justify-content: center;
  }

  .star-rating-container {
    justify-content: center;
  }

  /* 画像アップロードテキストの調整 */
  .image-upload-text {
    font-size: 0.75rem;
    line-height: 1.2;
    word-break: break-word;
    white-space: normal;
  }
}
</style>