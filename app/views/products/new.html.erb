<!-- æŠ•ç¨¿ãƒšãƒ¼ã‚¸ -->
<div class="pt-8 pb-4">
  <!-- ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒ¼ -->
  <div class="max-w-2xl w-full mx-auto px-4">
    <div class="bg-gray-200 rounded-full h-2.5 mb-2">
      <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%;"></div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—å -->
    <div class="flex justify-between max-w-2xl mx-auto mb-8 px-4" id="step-labels">
      <% steps = [
        { number: 1, label: "å•†å“æƒ…å ±", description: "å•†å“åãƒ»åº—èˆ—åãƒ»ä¾¡æ ¼ã‚’å…¥åŠ›" },
        { number: 2, label: "å‘³è¦šè©•ä¾¡", description: "5æ®µéšã§è©•ä¾¡" },
        { number: 3, label: "ã‚³ãƒ¡ãƒ³ãƒˆ", description: "è‡ªç”±ã«æ„Ÿæƒ³ã‚’æ›¸ã" }
      ] %>

      <% steps.each_with_index do |step, index| %>
        <div class="flex flex-col items-center w-1/3">
          <!-- ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚¢ã‚¤ã‚³ãƒ³ -->
          <div id="step-circle-<%= index + 1 %>" class="w-8 h-8 rounded-full border-2 border-primary text-primary flex items-center justify-center mb-2 font-bold">
            <%= step[:number] %>
          </div>
          <div class="text-sm font-semibold text-gray-800 step-label-text"><%= step[:label] %></div>
          <div class="text-xs text-gray-500 text-center mt-1"><%= step[:description] %></div>
        </div>
      <% end %>
    </div>

    <!-- ğŸ”§ é‡è¦: data-controllerå±æ€§ã‚’è¿½åŠ  -->
    <%= form_with model: @product, local: true, class: "space-y-4", data: { controller: "product-form" } do |f| %>
      <!-- ã‚¹ãƒ†ãƒƒãƒ—1: å•†å“æƒ…å ± -->
      <div class="max-w-xl mx-auto card bg-white shadow-md p-6 rounded-xl">
        <div id="step-1" class="step-panel" data-step="1">
          <div class="form-control">
            <%= f.label :name, class: "label" do %>
              <span class="label-text">å•†å“å<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <%= f.text_field :name, class: "input input-bordered w-full", placeholder: "ä¾‹ï¼šãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã‚±ãƒ¼ã‚­", required: true %>
          </div>

          <div class="form-control">
            <%= f.label :shop_name, class: "label" do %>
              <span class="label-text">åº—èˆ—å<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <%= f.text_field :shop_name, class: "input input-bordered w-full", placeholder: "ä¾‹:ãƒ‘ãƒ†ã‚£ã‚¹ãƒªãƒ¼â—‹â—‹", required: true %>
          </div>

          <!-- ä½æ‰€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <div class="form-control">
            <%= f.label :address, class: "label" do %>
              <span class="label-text">åº—èˆ—ä½æ‰€</span>
            <% end %>
            <%= f.text_field :address, class: "input input-bordered w-full", placeholder: "ä¾‹ï¼šæ±äº¬éƒ½æ¸‹è°·åŒºã€‡ã€‡1-2-3" %>
            <label class="label">
              <span class="label-text-alt text-gray-500">ä½æ‰€ã‚’å…¥åŠ›ã™ã‚‹ã¨åœ°å›³ã«è¡¨ç¤ºã•ã‚Œã¾ã™</span>
            </label>
          </div>

          <div class="form-control">
            <%= f.label :category, class: "label" do %>
              <span class="label-text">ã‚«ãƒ†ã‚´ãƒª<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <%= f.select :category, [
              ["ã‚±ãƒ¼ã‚­", "cake"],
              ["ãƒ‡ã‚¶ãƒ¼ãƒˆ", "dessert"],
              ["ã‚¢ã‚¤ã‚¹", "ice_cream"],
              ["å’Œè“å­", "japanese_sweets"],
              ["ãƒ‰ãƒªãƒ³ã‚¯", "drink"],
              ["ãƒ‘ãƒ•ã‚§", "parfait"],
              ["ãã®ä»–", "other"]
            ], { prompt: "ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„" }, { class: "select select-bordered w-full", required: true } %>
          </div>

          <div class="form-control">
            <%= f.label :price, class: "label" do %>
              <span class="label-text">ä¾¡æ ¼(å††)<span class="text-red-500 ml-1">*</span></span>
            <% end %>
            <div class="relative">
              <%= f.number_field :price, class: "input input-bordered w-full pr-12", placeholder: "500", min: 0, required: true %>
              <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">å††</span>
            </div>
          </div>

          <div class="form-control">
            <%= f.label :tag_names, class: "label" do %>
              <span class="label-text">ã‚¿ã‚°(, ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</span>
            <% end %>
            <%= f.text_field :tag_names, value: @product.tag_names, class: "input input-bordered w-full", placeholder: "ä¾‹:ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ, æ¿ƒåš, ãŠã™ã™ã‚" %>
          </div>

          <div class="flex justify-end mt-4">
            <button type="button" 
                    class="next-button btn btn-primary mt-4" 
                    data-action="click->product-form#nextStep" 
                    data-step="1">æ¬¡ã¸</button>
          </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2 & 3: ãƒ¬ãƒ“ãƒ¥ãƒ¼å…¥åŠ› + ã‚³ãƒ¡ãƒ³ãƒˆ -->
        <%= f.fields_for :review do |rf| %>
          <!-- ã‚¹ãƒ†ãƒƒãƒ—2: å‘³è¦šè©•ä¾¡ -->
          <div id="step-2" class="step-panel hidden" data-step="2">
            <div class="divider">ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±</div>
            <p class="text-sm text-gray-600 mb-4 text-center">å„é …ç›®ã‚’5æ®µéšã§è©•ä¾¡ã—ã¦ãã ã•ã„</p>

            <% [
              ["æ¿ƒã•", :richness, "â˜…", true],
              ["ç”˜ã•", :sweetness, "â˜…", true],
              ["è‹¦å‘³", :bitterness, "â˜…", true],
              ["å¾Œå‘³", :aftertaste, "â˜…", true],
              ["è¦‹ãŸç›®", :appearance, "â˜…", true]
            ].each do |label, name, symbol| %>
              <div class="form-control mb-4"
                   data-controller="stars"
                   data-stars-name="product[review_attributes][<%= name %>]"
                   data-stars-symbol-value="<%= symbol %>">

              <!-- å„è¦ç´ ã‚’å€‹åˆ¥ã«èª¿æ•´å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠ -->
              <div class="flex items-center w-full relative star-rating-container">
                <!-- ãƒ©ãƒ™ãƒ«éƒ¨åˆ† -->
                <div class="ml-10 w-20 flex-shrink-0 label-section">
                  <label class="label">
                    <span class="label-text font-medium"><%= label %><span class="text-red-500 ml-1">*</span></span>
                  </label>
                </div>

                <!-- æ˜Ÿè©•ä¾¡éƒ¨åˆ† -->
                <div class="ml-19 flex space-x-1 star-section">
                  <% 5.times do |i| %>
                    <i class="star cursor-pointer text-2xl text-gray-400 hover:text-yellow-400 transition-colors"
                       data-action="click->stars#select"
                       data-value="<%= i + 1 %>"><%= symbol %></i>
                  <% end %>
                </div>

                <!-- æ•°å€¤è¡¨ç¤ºéƒ¨åˆ† -->
                <div class="ml-20 flex items-center bg-gray-100 px-3 py-1 rounded-lg display-section">
                  <span class="text-xl font-bold text-gray-700 min-w-[2rem]" data-stars-target="display">
                    <%= @product.review&.send(name) || 0 %>
                  </span>
                  <span class="text-sm text-gray-500 ml-1">/ 5</span>
                </div>
              </div>
              
              <%= rf.hidden_field name, 
                  value: @product.review&.send(name) || 0,
                  data: { stars_target: "input" } %>
            </div>
            <% end %>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—2ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex justify-between mt-4">
              <button type="button" 
                      class="prev-button btn btn-secondary" 
                      data-action="click->product-form#prevStep">æˆ»ã‚‹</button>
              <button type="button" 
                      class="next-button btn btn-primary" 
                      data-action="click->product-form#nextStep" 
                      data-step="2">æ¬¡ã¸</button>
            </div>
          </div>

          <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ç”»åƒã¨ã‚³ãƒ¡ãƒ³ãƒˆ -->
          <div id="step-3" class="step-panel hidden" data-step="3">
            <div class="form-control">
              <%= f.label :image, class: "label" do %>
                <span class="label-text">ç”»åƒ</span>
              <% end %>
              <%= f.file_field :image, 
                  class: "file-input file-input-bordered w-full", 
                  accept: "image/*",
                  data: { action: "change->product-form#showImagePreview" } %>
              <label class="label">
                <span class="label-text-alt text-gray-500 image-upload-text">JPGã€PNGã€GIFå½¢å¼ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</span>
              </label>
              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é ˜åŸŸã¯JavaScriptã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>

            <div class="form-control">
              <%= rf.label :comment, class: "label" do %>
                <span class="label-text">ã‚³ãƒ¡ãƒ³ãƒˆ</span>
              <% end %>
              <%= rf.text_area :comment, class: "textarea textarea-bordered w-full h-32", placeholder: "å•†å“ã®æ„Ÿæƒ³ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’è‡ªç”±ã«ãŠæ›¸ããã ã•ã„..." %>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—3ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex justify-between mt-6">
              <button type="button" 
                      class="prev-button btn btn-secondary" 
                      data-action="click->product-form#prevStep">æˆ»ã‚‹</button>
              <button type="button" 
                      class="btn btn-primary" 
                      data-action="click->product-form#goToConfirm">ç¢ºèªç”»é¢ã¸ â†’</button>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<style>
/* ã‚¹ãƒãƒ›å¯¾å¿œã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–CSS */
@media (max-width: 768px) {
  .star-rating-container {
    flex-wrap: wrap;
    justify-content: flex-start;
    gap: 0;
  }

  .label-section {
    margin-left: 0;
    width: 100%;
    margin-bottom: 8px;
  }

  .star-section {
    margin-left: 0;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .display-section {
    margin-left: 0;
    flex-shrink: 0;
  }

  .star-rating-container .star-section,
  .star-rating-container .display-section {
    width: 100%;
    justify-content: center;
  }

  .star-rating-container {
    justify-content: center;
  }

  .image-upload-text {
    font-size: 0.75rem;
    line-height: 1.2;
    word-break: break-word;
    white-space: normal;
  }
}
</style>
